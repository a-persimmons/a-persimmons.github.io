<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>浅入Class字节码 | A-Persimmon`s</title>
<meta name=keywords content="Java,JDK,源码"><meta name=description content="浅入Class字节码."><meta name=author content="柿子"><link rel=canonical href=https://blog.codingforjoy.com/posts/%E6%B5%85%E5%85%A5class%E5%AD%97%E8%8A%82%E7%A0%81/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.codingforjoy.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://blog.codingforjoy.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://blog.codingforjoy.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://blog.codingforjoy.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://blog.codingforjoy.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="浅入Class字节码"><meta property="og:description" content="浅入Class字节码."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.codingforjoy.com/posts/%E6%B5%85%E5%85%A5class%E5%AD%97%E8%8A%82%E7%A0%81/"><meta property="og:image" content="https://blog.codingforjoy.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-20T20:59:25+00:00"><meta property="article:modified_time" content="2021-06-20T20:59:25+00:00"><meta property="og:site_name" content="Persimmon"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.codingforjoy.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="浅入Class字节码"><meta name=twitter:description content="浅入Class字节码."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.codingforjoy.com/posts/"},{"@type":"ListItem","position":2,"name":"浅入Class字节码","item":"https://blog.codingforjoy.com/posts/%E6%B5%85%E5%85%A5class%E5%AD%97%E8%8A%82%E7%A0%81/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"浅入Class字节码","name":"浅入Class字节码","description":"浅入Class字节码.","keywords":["Java","JDK","源码"],"articleBody":" 不以规矩，不成方圆\n“Write Once，Run Everywhere”，功归于虚拟机的“规范”\n基本数据类型 u1、u2、u4分别代表占用1字节、2字节、4字节 Class文件结构 自上而下\nClassFile { u4 magic; // 魔术 0xCAFEBABE u2 minor_version;// 次要版本，标识 m u2 major_version;// JDK主要版本,标识 M u2 constant_pool_count;// 常量池个数 cp_info constant_pool[constant_pool_count-1];// 常量池元素数组 下标从1开始 u2 access_flags;// 此类修饰符 u2 this_class;// 此包类或接口路径 如 com/amk/App u2 super_class;// 父类,至少是Object超类 u2 interfaces_count;// 实现接口个数 u2 interfaces[interfaces_count];// 具体的接口名数组 u2 fields_count;// 属性个数 field_info fields[fields_count];// 属性值 u2 methods_count;// 方法个数 method_info methods[methods_count];// 具体方法 u2 attributes_count;// 其他属性计数 attribute_info attributes[attributes_count];// 具体其他属性数组 } 十六进制码 具体看下Class文件\n需要的工具 Sublime 或者 01Editer\n预设知识：图解进制转换\n// 类 public class ClassStructure {} //javac ClassStructure 编译输出 Class文件 public class ClassStructure { // 默认无参构造 public ClassStructure() {} } 通过 Sublime打开,会看到是这样的,这就是Class 十六进制\ncafe babe 0000 0034 0010 0a00 0300 0d07 000e 0700 0f01 0006 3c69 6e69 743e 0100 0328 2956 0100 0443 6f64 6501 000f 4c69 6e65 4e75 6d62 6572 5461 626c 6501 0012 4c6f 6361 6c56 6172 6961 626c 6554 6162 6c65 0100 0474 6869 7301 0010 4c43 6c61 7373 5374 7275 6374 7572 653b 0100 0a53 6f75 7263 6546 696c 6501 0013 436c 6173 7353 7472 7563 7475 7265 2e6a 6176 610c 0004 0005 0100 0e43 6c61 7373 5374 7275 6374 7572 6501 0010 6a61 7661 2f6c 616e 672f 4f62 6a65 6374 0021 0002 0003 0000 0000 0001 0001 0004 0005 0001 0006 0000 002f 0001 0001 0000 0005 2ab7 0001 b100 0000 0200 0700 0000 0600 0100 0000 0400 0800 0000 0c00 0100 0000 0500 0900 0a00 0000 0100 0b00 0000 0200 0c 我们看到\"cafe babe“开头,这个就是魔数,可以理解为文件类型描述符,从上文得到魔数数据类型是u4,占用4个字节,得到一个码占用4位,下面我们来尝试读取一下\n方法:先看上面的ClassFile中的数据类型u*,在看对应的代表什么\ncafebabe : magic u4 0000: minor_version u2 0 0034: major_version u2 52=4x16^0+3x16^1 表格 0010:constant_pool_count u2 16 … 以此借助基本数据类型读取进制码 接下来看另一种数据类型读取方法: cp_info,需要借助IDEA\n常量池\njavap -v ClassStructure # 会看到如下结果 Classfile /target/test-classes/ClassStructure.class Last modified 2021年5月9日; size 267 bytes SHA-256 checksum d6a39a3bf56d982b11d79c38256f2f6b2a2f8745c38a4f86440fb9d701f44078 Compiled from \"ClassStructure.java\" public class ClassStructure # 次版本 minor version: 0 # JDK版本 major version: 52 # 类修饰符 flags: (0x0021) ACC_PUBLIC, ACC_SUPER # 类名 this_class: #2 // ClassStructure # 父类 super_class: #3 // java/lang/Object # 接口 变量 方法 其他属性 计数 interfaces: 0, fields: 0, methods: 1, attributes: 1 # 重点看这儿常量池 Constant pool: # 井号后面是索引 #1 = Methodref 方法 #3(指向3).#13(指向索引13) // java/lang/Object.\"\":()V #2 = Class #14 // ClassStructure #3 = Class #15 // java/lang/Object #4 = Utf8 #5 = Utf8 ()V #6 = Utf8 Code #7 = Utf8 LineNumberTable #8 = Utf8 LocalVariableTable #9 = Utf8 this #10 = Utf8 LClassStructure; #11 = Utf8 SourceFile #12 = Utf8 ClassStructure.java #13 = NameAndType #4:#5 // \"\":()V #14 = Utf8 ClassStructure #15 = Utf8 java/lang/Object { public ClassStructure(); descriptor: ()V flags: (0x0001) ACC_PUBLIC Code: stack=1, locals=1, args_size=1 0: aload_0 1: invokespecial #1 // Method java/lang/Object.\"\":()V 4: return LineNumberTable: line 4: 0 LocalVariableTable: Start Length Slot Name Signature 0 5 0 this LClassStructure; } SourceFile: \"ClassStructure.java\" constant_pool_count常量计数后面是常量元素(cp_info),通过规范查到的结构是\ncp_info { u1 tag; u1 info[]; } 所以接下来的u1一个字节0a为tag 10,然后在规定的17个tags得到是\"CONSTANT_Methodref\"在点击Section这一栏的超链接得到对应的结构为\n// 先知道是什么,后面有宏观解释 CONSTANT_Methodref_info { u1 tag; u2 class_index; // 指向常量池的下一个 类索引 联系上文[Constant pool]#3 u2 name_and_type_index; // 入参:返回类型 索引 练习上文[Constant pool]#15 } 宏观解释无参构造方法:\n// 联系 javap -v 输出结果 Constant pool { u1 tag; 0a // 代表17个Tags中tag为10的CONSTANT_Methodref // #3-\u003e#15-\u003ejava/lang/Object 表示类为Object 但是实际类型并不是暂时理解为通用类 // class_index 类为Object占位符,猜想运行时才会转化为具体的类型,TODO 待验证 u2 class_index; 0003 #3 -\u003e [#3 = Class #15] -\u003e [#15 = Utf8 java/lang/Object] // #13-\u003e#13 #4name:#5type -\u003e \"\":()V 表示无参构造方法 u2 name_and_type_index; 000d #13 -\u003e [#13 = NameAndType #4:#5]-\u003e [\"\":()V] } 以上读取了 “0a00 0300 0d\"常量池第一个元素的含义,后面的参照此方法\n总结读取步骤:\nu1 查tags表 链接Section栏的超链接查看具体的结构字节数 带着字节数索引在javap -v 总常量池[Constant pool]总向后推进 最后介绍个IDEA插件:jclasslib Bytecode Viewer代替Javap -v 更加直观\n插件参构造表示方式 参考:Oracle Class文件结构\nNext：用Java Buffer解析字节码\n","wordCount":"539","inLanguage":"en","image":"https://blog.codingforjoy.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2021-06-20T20:59:25Z","dateModified":"2021-06-20T20:59:25Z","author":[{"@type":"Person","name":"柿子"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.codingforjoy.com/posts/%E6%B5%85%E5%85%A5class%E5%AD%97%E8%8A%82%E7%A0%81/"},"publisher":{"@type":"Organization","name":"A-Persimmon`s","logo":{"@type":"ImageObject","url":"https://blog.codingforjoy.com/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.codingforjoy.com/ accesskey=h title="Home (Alt + H)"><img src=https://s2.loli.net/2024/05/31/ZoSPjtxUXDlLIC3.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.codingforjoy.com/about/ title=关于我><span>关于我</span></a></li><li><a href=https://blog.codingforjoy.com/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.codingforjoy.com/search/ title=搜索><span>搜索</span></a></li><li><a href=https://blog.codingforjoy.com/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.codingforjoy.com/>Home</a>&nbsp;»&nbsp;<a href=https://blog.codingforjoy.com/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">浅入Class字节码</h1><div class=post-description>浅入Class字节码.</div><div class=post-meta><span title='2021-06-20 20:59:25 +0000 UTC'>June 20, 2021</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;539 words&nbsp;·&nbsp;柿子</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#基本数据类型>基本数据类型</a></li><li><a href=#class文件结构>Class文件结构</a></li><li><a href=#十六进制码>十六进制码</a></li><li><a href=#插件参构造表示方式>插件参构造表示方式</a></li></ul></li></ul></nav></div></details></div><div class=post-content><blockquote><p>不以规矩，不成方圆</p></blockquote><p>“Write Once，Run Everywhere”，功归于虚拟机的“规范”</p><h3 id=基本数据类型>基本数据类型<a hidden class=anchor aria-hidden=true href=#基本数据类型>#</a></h3><ul><li>u1、u2、u4分别代表占用1字节、2字节、4字节</li></ul><h3 id=class文件结构>Class文件结构<a hidden class=anchor aria-hidden=true href=#class文件结构>#</a></h3><p>自上而下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ClassFile</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u4</span><span class=w>             </span><span class=n>magic</span><span class=p>;</span><span class=w> </span><span class=c1>// 魔术 0xCAFEBABE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w>             </span><span class=n>minor_version</span><span class=p>;</span><span class=c1>// 次要版本，标识 m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w>             </span><span class=n>major_version</span><span class=p>;</span><span class=c1>// JDK主要版本,标识 M</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w>             </span><span class=n>constant_pool_count</span><span class=p>;</span><span class=c1>// 常量池个数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cp_info</span><span class=w>        </span><span class=n>constant_pool</span><span class=o>[</span><span class=n>constant_pool_count</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=c1>// 常量池元素数组 下标从1开始</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w>             </span><span class=n>access_flags</span><span class=p>;</span><span class=c1>// 此类修饰符</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w>             </span><span class=n>this_class</span><span class=p>;</span><span class=c1>// 此包类或接口路径 如 com/amk/App</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w>             </span><span class=n>super_class</span><span class=p>;</span><span class=c1>// 父类,至少是Object超类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w>             </span><span class=n>interfaces_count</span><span class=p>;</span><span class=c1>// 实现接口个数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w>             </span><span class=n>interfaces</span><span class=o>[</span><span class=n>interfaces_count</span><span class=o>]</span><span class=p>;</span><span class=c1>// 具体的接口名数组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w>             </span><span class=n>fields_count</span><span class=p>;</span><span class=c1>// 属性个数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field_info</span><span class=w>     </span><span class=n>fields</span><span class=o>[</span><span class=n>fields_count</span><span class=o>]</span><span class=p>;</span><span class=c1>// 属性值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w>             </span><span class=n>methods_count</span><span class=p>;</span><span class=c1>// 方法个数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>method_info</span><span class=w>    </span><span class=n>methods</span><span class=o>[</span><span class=n>methods_count</span><span class=o>]</span><span class=p>;</span><span class=c1>// 具体方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w>             </span><span class=n>attributes_count</span><span class=p>;</span><span class=c1>// 其他属性计数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>attribute_info</span><span class=w> </span><span class=n>attributes</span><span class=o>[</span><span class=n>attributes_count</span><span class=o>]</span><span class=p>;</span><span class=c1>// 具体其他属性数组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=十六进制码>十六进制码<a hidden class=anchor aria-hidden=true href=#十六进制码>#</a></h3><p>具体看下Class文件</p><blockquote><p>需要的工具 Sublime 或者 01Editer</p><p>预设知识：<a href=https://www.cnblogs.com/gaizai/p/4233780.html>图解进制转换</a></p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ClassStructure</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//javac ClassStructure 编译输出 Class文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ClassStructure</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// 默认无参构造</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=nf>ClassStructure</span><span class=p>()</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>通过 Sublime打开,会看到是这样的,这就是Class 十六进制</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>cafe</span><span class=w> </span><span class=n>babe</span><span class=w> </span><span class=n>0000</span><span class=w> </span><span class=n>0034</span><span class=w> </span><span class=n>0010</span><span class=w> </span><span class=n>0a00</span><span class=w> </span><span class=n>0300</span><span class=w> </span><span class=n>0d07</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>000e</span><span class=w> </span><span class=n>0700</span><span class=w> </span><span class=n>0f01</span><span class=w> </span><span class=n>0006</span><span class=w> </span><span class=n>3c69</span><span class=w> </span><span class=n>6e69</span><span class=w> </span><span class=n>743e</span><span class=w> </span><span class=n>0100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>0328</span><span class=w> </span><span class=n>2956</span><span class=w> </span><span class=n>0100</span><span class=w> </span><span class=n>0443</span><span class=w> </span><span class=n>6f64</span><span class=w> </span><span class=n>6501</span><span class=w> </span><span class=n>000f</span><span class=w> </span><span class=n>4c69</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6e65</span><span class=w> </span><span class=n>4e75</span><span class=w> </span><span class=n>6d62</span><span class=w> </span><span class=n>6572</span><span class=w> </span><span class=n>5461</span><span class=w> </span><span class=n>626c</span><span class=w> </span><span class=n>6501</span><span class=w> </span><span class=n>0012</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4c6f</span><span class=w> </span><span class=n>6361</span><span class=w> </span><span class=n>6c56</span><span class=w> </span><span class=n>6172</span><span class=w> </span><span class=n>6961</span><span class=w> </span><span class=n>626c</span><span class=w> </span><span class=n>6554</span><span class=w> </span><span class=n>6162</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6c65</span><span class=w> </span><span class=n>0100</span><span class=w> </span><span class=n>0474</span><span class=w> </span><span class=n>6869</span><span class=w> </span><span class=n>7301</span><span class=w> </span><span class=n>0010</span><span class=w> </span><span class=n>4c43</span><span class=w> </span><span class=n>6c61</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7373</span><span class=w> </span><span class=n>5374</span><span class=w> </span><span class=n>7275</span><span class=w> </span><span class=n>6374</span><span class=w> </span><span class=n>7572</span><span class=w> </span><span class=n>653b</span><span class=w> </span><span class=n>0100</span><span class=w> </span><span class=n>0a53</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6f75</span><span class=w> </span><span class=n>7263</span><span class=w> </span><span class=n>6546</span><span class=w> </span><span class=n>696c</span><span class=w> </span><span class=n>6501</span><span class=w> </span><span class=n>0013</span><span class=w> </span><span class=n>436c</span><span class=w> </span><span class=n>6173</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7353</span><span class=w> </span><span class=n>7472</span><span class=w> </span><span class=n>7563</span><span class=w> </span><span class=n>7475</span><span class=w> </span><span class=n>7265</span><span class=w> </span><span class=n>2e6a</span><span class=w> </span><span class=n>6176</span><span class=w> </span><span class=n>610c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>0004</span><span class=w> </span><span class=n>0005</span><span class=w> </span><span class=n>0100</span><span class=w> </span><span class=n>0e43</span><span class=w> </span><span class=n>6c61</span><span class=w> </span><span class=n>7373</span><span class=w> </span><span class=n>5374</span><span class=w> </span><span class=n>7275</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6374</span><span class=w> </span><span class=n>7572</span><span class=w> </span><span class=n>6501</span><span class=w> </span><span class=n>0010</span><span class=w> </span><span class=n>6a61</span><span class=w> </span><span class=n>7661</span><span class=w> </span><span class=n>2f6c</span><span class=w> </span><span class=n>616e</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>672f</span><span class=w> </span><span class=n>4f62</span><span class=w> </span><span class=n>6a65</span><span class=w> </span><span class=n>6374</span><span class=w> </span><span class=n>0021</span><span class=w> </span><span class=n>0002</span><span class=w> </span><span class=n>0003</span><span class=w> </span><span class=n>0000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>0000</span><span class=w> </span><span class=n>0001</span><span class=w> </span><span class=n>0001</span><span class=w> </span><span class=n>0004</span><span class=w> </span><span class=n>0005</span><span class=w> </span><span class=n>0001</span><span class=w> </span><span class=n>0006</span><span class=w> </span><span class=n>0000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>002f</span><span class=w> </span><span class=n>0001</span><span class=w> </span><span class=n>0001</span><span class=w> </span><span class=n>0000</span><span class=w> </span><span class=n>0005</span><span class=w> </span><span class=n>2ab7</span><span class=w> </span><span class=n>0001</span><span class=w> </span><span class=n>b100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>0000</span><span class=w> </span><span class=n>0200</span><span class=w> </span><span class=n>0700</span><span class=w> </span><span class=n>0000</span><span class=w> </span><span class=n>0600</span><span class=w> </span><span class=n>0100</span><span class=w> </span><span class=n>0000</span><span class=w> </span><span class=n>0400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>0800</span><span class=w> </span><span class=n>0000</span><span class=w> </span><span class=n>0c00</span><span class=w> </span><span class=n>0100</span><span class=w> </span><span class=n>0000</span><span class=w> </span><span class=n>0500</span><span class=w> </span><span class=n>0900</span><span class=w> </span><span class=n>0a00</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>0000</span><span class=w> </span><span class=n>0100</span><span class=w> </span><span class=n>0b00</span><span class=w> </span><span class=n>0000</span><span class=w> </span><span class=n>0200</span><span class=w> </span><span class=n>0c</span><span class=w>
</span></span></span></code></pre></div><p>我们看到"<strong>cafe babe</strong>&ldquo;开头,这个就是<strong>魔数</strong>,可以理解为文件类型描述符,从上文得到魔数数据类型是u4,占用4个字节,得到一个码占用4位,下面我们来尝试读取一下</p><p>方法:先看上面的<code>ClassFile</code>中的数据类型u*,在看对应的代表什么</p><ul><li>cafebabe : magic u4</li><li>0000: minor_version u2 <strong>0</strong></li><li>0034: major_version u2 <strong>52</strong>=<code>4x16^0+3x16^1</code> <a href=https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-4.html#jvms-4.1-200-B.2>表格</a></li><li>0010:constant_pool_count u2 <strong>16</strong></li><li>&mldr;</li><li>以此借助基本数据类型读取进制码</li></ul><p>接下来看另一种数据类型读取方法: <code>cp_info</code>,需要借助IDEA</p><ul><li><p>常量池</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>javap -v ClassStructure 
</span></span><span class=line><span class=cl><span class=c1># 会看到如下结果</span>
</span></span><span class=line><span class=cl>Classfile /target/test-classes/ClassStructure.class
</span></span><span class=line><span class=cl>  Last modified 2021年5月9日<span class=p>;</span> size <span class=m>267</span> bytes
</span></span><span class=line><span class=cl>  SHA-256 checksum d6a39a3bf56d982b11d79c38256f2f6b2a2f8745c38a4f86440fb9d701f44078
</span></span><span class=line><span class=cl>  Compiled from <span class=s2>&#34;ClassStructure.java&#34;</span>
</span></span><span class=line><span class=cl>public class ClassStructure
</span></span><span class=line><span class=cl>  <span class=c1># 次版本</span>
</span></span><span class=line><span class=cl>  minor version: <span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=c1># JDK版本</span>
</span></span><span class=line><span class=cl>  major version: <span class=m>52</span>
</span></span><span class=line><span class=cl>  <span class=c1># 类修饰符</span>
</span></span><span class=line><span class=cl>  flags: <span class=o>(</span>0x0021<span class=o>)</span> ACC_PUBLIC, ACC_SUPER
</span></span><span class=line><span class=cl>  <span class=c1># 类名</span>
</span></span><span class=line><span class=cl>  this_class: <span class=c1>#2                          // ClassStructure</span>
</span></span><span class=line><span class=cl>  <span class=c1># 父类</span>
</span></span><span class=line><span class=cl>  super_class: <span class=c1>#3                         // java/lang/Object</span>
</span></span><span class=line><span class=cl>  <span class=c1># 接口 变量 方法 其他属性 计数</span>
</span></span><span class=line><span class=cl>  interfaces: 0, fields: 0, methods: 1, attributes: <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=c1># 重点看这儿常量池</span>
</span></span><span class=line><span class=cl>Constant pool:
</span></span><span class=line><span class=cl><span class=c1># 井号后面是索引</span>
</span></span><span class=line><span class=cl>   <span class=c1>#1 = Methodref 方法      #3(指向3).#13(指向索引13) // java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class=line><span class=cl>   <span class=c1>#2 = Class              #14            // ClassStructure</span>
</span></span><span class=line><span class=cl>   <span class=c1>#3 = Class              #15            // java/lang/Object</span>
</span></span><span class=line><span class=cl>   <span class=c1>#4 = Utf8               &lt;init&gt;</span>
</span></span><span class=line><span class=cl>   <span class=c1>#5 = Utf8               ()V</span>
</span></span><span class=line><span class=cl>   <span class=c1>#6 = Utf8               Code</span>
</span></span><span class=line><span class=cl>   <span class=c1>#7 = Utf8               LineNumberTable</span>
</span></span><span class=line><span class=cl>   <span class=c1>#8 = Utf8               LocalVariableTable</span>
</span></span><span class=line><span class=cl>   <span class=c1>#9 = Utf8               this</span>
</span></span><span class=line><span class=cl>  <span class=c1>#10 = Utf8               LClassStructure;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#11 = Utf8               SourceFile</span>
</span></span><span class=line><span class=cl>  <span class=c1>#12 = Utf8               ClassStructure.java</span>
</span></span><span class=line><span class=cl>  <span class=c1>#13 = NameAndType        #4:#5          // &#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class=line><span class=cl>  <span class=c1>#14 = Utf8               ClassStructure</span>
</span></span><span class=line><span class=cl>  <span class=c1>#15 = Utf8               java/lang/Object</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  public ClassStructure<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    descriptor: <span class=o>()</span>V
</span></span><span class=line><span class=cl>    flags: <span class=o>(</span>0x0001<span class=o>)</span> ACC_PUBLIC
</span></span><span class=line><span class=cl>    Code:
</span></span><span class=line><span class=cl>      <span class=nv>stack</span><span class=o>=</span>1, <span class=nv>locals</span><span class=o>=</span>1, <span class=nv>args_size</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>         0: aload_0
</span></span><span class=line><span class=cl>         1: invokespecial <span class=c1>#1                  // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class=line><span class=cl>         4: <span class=k>return</span>
</span></span><span class=line><span class=cl>      LineNumberTable:
</span></span><span class=line><span class=cl>        line 4: <span class=m>0</span>
</span></span><span class=line><span class=cl>      LocalVariableTable:
</span></span><span class=line><span class=cl>        Start  Length  Slot  Name   Signature
</span></span><span class=line><span class=cl>            <span class=m>0</span>       <span class=m>5</span>     <span class=m>0</span>  this   LClassStructure<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>SourceFile: <span class=s2>&#34;ClassStructure.java&#34;</span>
</span></span></code></pre></div></li><li><p>constant_pool_count常量计数后面是常量元素(cp_info),通过规范查到的结构是</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>cp_info</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u1</span><span class=w> </span><span class=n>tag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u1</span><span class=w> </span><span class=n>info</span><span class=o>[]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>所以接下来的<code>u1</code>一个字节<code>0a</code>为tag <code>10</code>,然后在规定的<a href=https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-4.html#jvms-4.4-140>17个tags</a>得到是"CONSTANT_Methodref"在点击<code>Section</code>这一栏的超链接得到对应的结构为</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 先知道是什么,后面有宏观解释</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CONSTANT_Methodref_info</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u1</span><span class=w> </span><span class=n>tag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w> </span><span class=n>class_index</span><span class=p>;</span><span class=w> </span><span class=c1>// 指向常量池的下一个 类索引 联系上文[Constant pool]#3 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>u2</span><span class=w> </span><span class=n>name_and_type_index</span><span class=p>;</span><span class=w> </span><span class=c1>// 入参:返回类型 索引 练习上文[Constant pool]#15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>宏观解释无参构造方法:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 联系 javap -v 输出结果 Constant pool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>u1</span><span class=w> </span><span class=n>tag</span><span class=p>;</span><span class=w> </span><span class=n>0a</span><span class=w> </span><span class=c1>// 代表17个Tags中tag为10的CONSTANT_Methodref</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// #3-&gt;#15-&gt;java/lang/Object 表示类为Object 但是实际类型并不是暂时理解为通用类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// class_index 类为Object占位符,猜想运行时才会转化为具体的类型,TODO 待验证</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>u2</span><span class=w> </span><span class=n>class_index</span><span class=p>;</span><span class=w> </span><span class=n>0003</span><span class=w> </span><span class=err>#</span><span class=n>3</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=o>[</span><span class=err>#</span><span class=n>3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=w> </span><span class=err>#</span><span class=n>15</span><span class=o>]</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=o>[</span><span class=err>#</span><span class=n>15</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utf8</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Object</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// #13-&gt;#13 #4name:#5type -&gt; &#34;&lt;init&gt;&#34;:()V 表示无参构造方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>u2</span><span class=w> </span><span class=n>name_and_type_index</span><span class=p>;</span><span class=w> </span><span class=n>000d</span><span class=w> </span><span class=err>#</span><span class=n>13</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=o>[</span><span class=err>#</span><span class=n>13</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NameAndType</span><span class=w> </span><span class=err>#</span><span class=n>4</span><span class=p>:</span><span class=err>#</span><span class=n>5</span><span class=o>]-&gt;</span><span class=w> </span><span class=o>[</span><span class=s>&#34;&lt;init&gt;&#34;</span><span class=p>:()</span><span class=n>V</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>以上读取了 &ldquo;0a00 0300 0d"常量池第一个元素的含义,后面的参照此方法</p><blockquote><p>总结读取步骤:</p><ul><li>u1 查<a href=https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-4.html#jvms-4.4-140>tags表</a></li><li>链接Section栏的超链接查看具体的结构字节数</li><li>带着字节数索引在javap -v 总常量池[Constant pool]总向后推进</li></ul></blockquote></li></ul><p>最后介绍个IDEA插件:<a href=https://plugins.jetbrains.com/plugin/9248-jclasslib-bytecode-viewer>jclasslib Bytecode Viewer</a>代替Javap -v 更加直观</p><h3 id=插件参构造表示方式>插件参构造表示方式<a hidden class=anchor aria-hidden=true href=#插件参构造表示方式>#</a></h3><p><img loading=lazy src=https://i.loli.net/2021/08/19/ld9DufrnTHOVwt2.png alt=image-20210509232109822></p><blockquote><p>参考:<a href=https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-4.html#jvms-4.4>Oracle Class文件结构</a></p></blockquote><p>Next：用Java Buffer解析字节码</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.codingforjoy.com/tags/java/>Java</a></li><li><a href=https://blog.codingforjoy.com/tags/jdk/>JDK</a></li><li><a href=https://blog.codingforjoy.com/tags/%E6%BA%90%E7%A0%81/>源码</a></li></ul><nav class=paginav><a class=prev href=https://blog.codingforjoy.com/posts/mysql%E8%B0%83%E4%BC%98%E7%90%86%E8%AE%BA%E7%AF%87/><span class=title>« Prev</span><br><span>Mysql调优理论篇</span>
</a><a class=next href=https://blog.codingforjoy.com/posts/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E5%8F%91%E7%94%9Foom%E5%85%B6%E4%BB%96%E7%BA%BF%E7%A8%8B%E4%B8%8D%E4%BC%9A%E5%81%9C%E6%AD%A2/><span class=title>Next »</span><br><span>多线程下发生OOM其他线程不会停止</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.codingforjoy.com/>A-Persimmon`s</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>